datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id             String        @id @default(cuid())
  email          String        @unique
  ethAddr        String?       @unique
  loginNonce     String?
  role           String
  properties     Property[]    @relation("ownerProperties")
  leasesAsOwner  Lease[]       @relation("ownerLeases")
  leasesAsTenant Lease[]       @relation("tenantLeases")
  listings       Listing[]
  applications   Application[] @relation("ApplicantApplications")
}

model Property {
  id        String    @id @default(cuid())
  ownerId   String
  owner     User      @relation("ownerProperties", fields: [ownerId], references: [id])
  name      String
  address   String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  leases    Lease[]
  listings  Listing[]
}

model Listing {
  id           String        @id @default(cuid())
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  ownerId      String
  owner        User          @relation(fields: [ownerId], references: [id])
  title        String
  address1     String
  city         String
  state        String
  postalCode   String?
  rentEth      Decimal
  beds         Int
  baths        Decimal?
  sqft         Int?
  amenities    String?
  photoUrl     String?
  available    Boolean       @default(true)
  source       String        @default("mock")
  externalUrl  String?
  propertyId   String?
  property     Property?     @relation(fields: [propertyId], references: [id])
  applications Application[]
  leases       Lease[]
}

model Lease {
  id                 String        @id @default(cuid())
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  propertyId         String
  property           Property      @relation(fields: [propertyId], references: [id])
  listingId          String?
  listing            Listing?      @relation(fields: [listingId], references: [id])
  ownerId            String
  owner              User          @relation("ownerLeases", fields: [ownerId], references: [id])
  tenantId           String
  tenant             User          @relation("tenantLeases", fields: [tenantId], references: [id])
  tenantEth          String
  chainLeaseId       Int?
  chainId            String?
  txHash             String?
  termsHash          String?
  pdfPath            String?
  ownerSignedAt      DateTime?
  tenantSignedAt     DateTime?
  signedAt           DateTime?
  startISO           String
  endISO             String
  dueDay             Int
  monthlyRentEth     Decimal
  annualRentEth      Decimal       @default("0")
  securityDepositEth Decimal
  depositBalanceEth  Decimal       @default("0")
  notes              String?
  status             String        @default("pending")
  autopayEnabled     Boolean       @default(false)
  invoices           Invoice[]
  receipts           Receipt[]
  repairs            Repair[]
  applications       Application[]
}

model Invoice {
  id             String   @id @default(cuid())
  createdAt      DateTime @default(now())
  leaseId        String
  lease          Lease    @relation(fields: [leaseId], references: [id])
  periodStartISO String
  periodEndISO   String
  dueISO         String
  amountEth      Decimal
  lateFeeEth     Decimal  @default("0")
  status         String   @default("unpaid")
  chainId        String?
  txHash         String?
  Receipt        Receipt?
}

model Receipt {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  leaseId   String
  lease     Lease    @relation(fields: [leaseId], references: [id])
  invoiceId String   @unique
  invoice   Invoice  @relation(fields: [invoiceId], references: [id])
  paidEth   Decimal
  paidAtISO String
  chainId   String
  txHash    String
  pdfPath   String?
}

model Repair {
  id             String    @id @default(cuid())
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  leaseId        String
  lease          Lease     @relation(fields: [leaseId], references: [id])
  title          String
  detail         String?
  costEth        Decimal?
  status         String    @default("open")
  chainRequestId String?
  chainTxHash    String?
  deductedEth    Decimal?
  deductedAt     DateTime?
}

model Profile {
  id           Int      @id @default(autoincrement())
  name         String
  contact      String
  graceDays    Int      @default(3)
  lateFeeType  String   @default("fixed")
  lateFeeValue Decimal  @default("0")
  updatedAt    DateTime @updatedAt
}

model Application {
  id             String   @id @default(cuid())
  listingId      String
  listing        Listing  @relation(fields: [listingId], references: [id])
  applicantId    String?
  applicant      User?    @relation("ApplicantApplications", fields: [applicantId], references: [id])
  applicantEmail String
  applicantName  String
  applicantPhone String?
  wallet         String
  message        String?
  status         String   @default("submitted")
  leaseId        String?
  lease          Lease?   @relation(fields: [leaseId], references: [id])
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}
